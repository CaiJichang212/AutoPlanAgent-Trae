# AutoPlanAgent - è‡ªåŠ¨åŒ–æ•°æ®åˆ†ææ™ºèƒ½ä½“

AutoPlanAgent æ˜¯ä¸€ä¸ªåŸºäº **LangGraph** æ„å»ºçš„é«˜çº§æ•°æ®åˆ†ææ™ºèƒ½ä½“ç³»ç»Ÿã€‚å®ƒèƒ½å¤Ÿæ·±åº¦ç†è§£ç”¨æˆ·çš„è‡ªç„¶è¯­è¨€éœ€æ±‚ï¼Œè‡ªåŠ¨æ‹†è§£åˆ†æä»»åŠ¡ï¼Œå¹¶åœ¨ç”¨æˆ·ç¡®è®¤åè‡ªä¸»æ‰§è¡Œ SQL æŸ¥è¯¢ã€Python æ•°æ®å¤„ç†å’Œä¸“ä¸šå¯è§†åŒ–ï¼Œæœ€ç»ˆäº§å‡ºç»“æ„åŒ–çš„åˆ†ææŠ¥å‘Šã€‚

## ğŸŒŸ æ ¸å¿ƒç‰¹æ€§

- **è‡ªä¸»è§„åˆ’ (Autonomous Planning)**: èƒ½å¤Ÿå°†å¤æ‚çš„åˆ†æç›®æ ‡ï¼ˆå¦‚â€œåˆ†æå…‰ä¼è¡Œä¸šè¿‡å»ä¸¤å¹´çš„è´¢åŠ¡è¡¨ç°â€ï¼‰è‡ªåŠ¨æ‹†è§£ä¸ºæ•°æ®æå–ã€æ¸…æ´—ã€æ¢ç´¢æ€§åˆ†æå’Œå¯è§†åŒ–ç­‰å…·ä½“æ­¥éª¤ã€‚
- **äººæœºåä½œ (Human-in-the-loop)**: åˆ©ç”¨ LangGraph çš„ `interrupt_before` æœºåˆ¶ï¼Œåœ¨è®¡åˆ’ç”Ÿæˆåè‡ªåŠ¨è¿›å…¥ä¸­æ–­çŠ¶æ€ï¼Œç­‰å¾…ç”¨æˆ·å®¡æŸ¥å’Œåé¦ˆï¼Œç¡®ä¿åˆ†æè·¯å¾„ç¬¦åˆé¢„æœŸã€‚
- **çŠ¶æ€æŒä¹…åŒ– (Persistence)**: åŸºäº `MemorySaver` çš„ Checkpointer æœºåˆ¶ï¼Œæ”¯æŒä»»åŠ¡ä¸­æ–­æ¢å¤ã€å¤šè½®å¯¹è¯åé¦ˆåŠçŠ¶æ€è¿½è¸ªï¼Œå¯é€šè¿‡ `thread_id` æ¢å¤ä¼šè¯ã€‚
- **å¤šæ¨¡å‹æ”¯æŒ (Multi-LLM Support)**: å†…ç½®å¯¹ ModelScopeã€SiliconFlow åŠ OpenAI å…¼å®¹æ¥å£çš„æ”¯æŒï¼Œé€‚é… Qwenã€DeepSeek ç­‰å‰æ²¿å¤§æ¨¡å‹ã€‚
- **å·¥å…·å¢å¼º (Tool-Augmented)**: 
  - **SQL æŸ¥è¯¢**: è‡ªåŠ¨æ„ŸçŸ¥æ•°æ®åº“ Schemaï¼Œç”Ÿæˆå¹¶æ‰§è¡Œé«˜æ•ˆçš„ MySQL æŸ¥è¯¢ã€‚
  - **Python åˆ†æ**: é›†æˆ Pandasã€NumPyã€Statsmodelsã€Scikit-learn ç­‰åº“ï¼Œæ”¯æŒç»Ÿè®¡å»ºæ¨¡ã€è¶‹åŠ¿åˆ†æåŠå¤æ‚é€»è¾‘è®¡ç®—ã€‚
  - **ä¸“ä¸šå¯è§†åŒ–**: ä½¿ç”¨ Matplotlib å’Œ Seaborn ç”Ÿæˆé«˜è´¨é‡å›¾è¡¨ï¼Œå†…ç½®å¤šå¹³å°ï¼ˆmacOS/Windows/Linuxï¼‰ä¸­æ–‡å­—ä½“è‡ªåŠ¨é€‚é…ã€‚
- **è‡ªåŠ¨åŒ–æŠ¥å‘Š (Auto-Reporting)**: åŸºäº Jinja2 æ¨¡æ¿å¼•æ“ï¼Œè‡ªåŠ¨æ±‡æ€»å„æ­¥éª¤æ‰§è¡Œç»“æœï¼Œç”ŸæˆåŒ…å«å…³é”®å‘ç°ã€ä¸šåŠ¡å»ºè®®å’Œå›¾è¡¨é™„å½•çš„ç»“æ„åŒ– Markdown æŠ¥å‘Šã€‚

## ğŸ—ï¸ é¡¹ç›®æ¶æ„

é¡¹ç›®é‡‡ç”¨ LangGraph çš„æœ‰å‘æ— ç¯å›¾ (DAG) æ¨¡å‹è¿›è¡Œæµè½¬æ§åˆ¶ï¼Œæ ¸å¿ƒé€»è¾‘å¦‚ä¸‹ï¼š

```mermaid
graph TD
    Start((å¼€å§‹)) --> Understand[ä»»åŠ¡ç†è§£]
    Understand --> Plan[ä»»åŠ¡æ‹†è§£ä¸è§„åˆ’]
    Plan --> WaitConfirm{ç­‰å¾…ç”¨æˆ·ç¡®è®¤}
    WaitConfirm -- ä¿®æ”¹å»ºè®® --> Plan
    WaitConfirm -- ç¡®è®¤é€šè¿‡ --> Execute[æ‰§è¡Œè®¡åˆ’æ­¥éª¤]
    
    Execute --> Check{æ£€æŸ¥æ‰§è¡ŒçŠ¶æ€}
    Check -- å‰©ä½™æ­¥éª¤ --> Execute
    Check -- æ‰§è¡Œå‡ºé”™ --> End((ç»“æŸ))
    Check -- å…¨éƒ¨å®Œæˆ --> Report[ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š]
    
    Report --> End
```

### æ ¸å¿ƒæ¨¡å—è¯´æ˜
- **[graph.py](file:///Users/lzc/TNTprojectZ/AutoPlanAgent-Trae/agent/graph.py)**: å®šä¹‰ LangGraph çŠ¶æ€æœºã€èŠ‚ç‚¹æµè½¬é€»è¾‘åŠä¸­æ–­ç­–ç•¥ã€‚
- **[nodes/](file:///Users/lzc/TNTprojectZ/AutoPlanAgent-Trae/agent/nodes/)**: åŒ…å«ä»»åŠ¡ç†è§£ã€è§„åˆ’ã€æ‰§è¡Œã€åé¦ˆå’ŒæŠ¥å‘Šç”Ÿæˆçš„å…·ä½“ä¸šåŠ¡é€»è¾‘ã€‚
- **[tools/](file:///Users/lzc/TNTprojectZ/AutoPlanAgent-Trae/agent/tools/)**: 
    - `db_tools.py`: æ•°æ®åº“è¿æ¥ã€Schema è·å–åŠ SQL æ‰§è¡Œã€‚
    - `analysis_tools.py`: Python REPL ç¯å¢ƒï¼Œç”¨äºæ•°æ®å¤„ç†å’Œå»ºæ¨¡ã€‚
    - `viz_tools.py`: è‡ªåŠ¨åŒ–ç»˜å›¾å·¥å…·ï¼Œæ”¯æŒè·¨å¹³å°ä¸­æ–‡å­—ä½“é€‚é…ã€‚
- **[state.py](file:///Users/lzc/TNTprojectZ/AutoPlanAgent-Trae/agent/state.py)**: å®šä¹‰æ™ºèƒ½ä½“çš„å…¨å±€çŠ¶æ€ Schema (`TypedDict`)ã€‚
- **[utils.py](file:///Users/lzc/TNTprojectZ/AutoPlanAgent-Trae/agent/utils.py)**: åŒ…å«å¤šæ¨¡å‹åŠ è½½ã€æ—¥å¿—é…ç½®åŠæ–‡æœ¬å¤„ç†å·¥å…·ã€‚

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒå®‰è£…

å…‹éš†ä»“åº“å¹¶å®‰è£…ä¾èµ–ï¼š

```bash
pip install -r requirements.txt
```

### 2. é…ç½®ç¯å¢ƒå˜é‡

åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `.env` æ–‡ä»¶ï¼Œé…ç½®ä½ çš„ API å¯†é’¥å’Œæ•°æ®åº“ä¿¡æ¯ï¼š

```env
# æ¨¡å‹é…ç½® (ä¸‰é€‰ä¸€æˆ–ç»„åˆä½¿ç”¨)
MODELSCOPE_API_KEYS=key1,key2
SILICONFLOW_API_KEYS=key1,key2
OPENAI_API_KEY=your_openai_key
OPENAI_API_BASE=https://api.openai.com/v1

# é»˜è®¤ä½¿ç”¨çš„æ¨¡å‹åç§°
MODEL_NAME=Qwen/Qwen2.5-72B-Instruct

# æ•°æ®åº“é…ç½® (ç›®å‰ä»…æ”¯æŒ MySQL)
DATABASE_URL=mysql+pymysql://user:password@localhost:3306/your_db

# å¯é€‰ï¼šæœç´¢å¢å¼º
TAVILY_API_KEY=your_tavily_key
```

### 3. æ•°æ®å‡†å¤‡

æœ¬é¡¹ç›®æä¾›äº†ç¤ºä¾‹å…‰ä¼è¡Œä¸šè´¢åŠ¡æ•°æ®è„šæœ¬ï¼š

```bash
# æ–¹æ¡ˆ Aï¼šå†™å…¥æœ¬åœ°æ¨¡æ‹Ÿæ•°æ®åˆ° MySQL
python data/prepare_pv_data.py

# æ–¹æ¡ˆ Bï¼šé€šè¿‡ AkShare æŠ“å–çœŸå®å…‰ä¼è´¢åŠ¡æ•°æ®å¹¶å†™å…¥
pip install akshare
python data/load_pv_financials_akshare.py --pv-table pv_financials
```

### 4. è¿è¡Œ Agent

#### å‘½ä»¤è¡Œäº¤äº’ (CLI)
```bash
# è¿è¡Œæ¼”ç¤ºè„šæœ¬ï¼Œä½“éªŒâ€œç†è§£-è§„åˆ’-ç¡®è®¤-æ‰§è¡Œ-æŠ¥å‘Šâ€å®Œæ•´æµç¨‹
python test_agent.py
```

#### RESTful API æœåŠ¡
```bash
# å¯åŠ¨ FastAPI æœåŠ¡
uvicorn app:app --host 0.0.0.0 --port 8000 --reload
```
æœåŠ¡å¯åŠ¨åï¼Œè®¿é—® `http://127.0.0.1:8000/docs` æŸ¥çœ‹ Swagger API æ–‡æ¡£ã€‚

**ä¸»è¦æ¥å£ï¼š**
- `POST /tasks/start`: æäº¤åˆå§‹éœ€æ±‚ï¼Œè¿”å› `thread_id` å’Œåˆæ­¥è®¡åˆ’ã€‚
- `POST /tasks/feedback`: æäº¤ç”¨æˆ·åé¦ˆï¼ˆå¦‚â€œåŒæ„â€æˆ–â€œä¿®æ”¹æ­¥éª¤â€ï¼‰ã€‚
- `GET /tasks/{thread_id}/status`: æŸ¥è¯¢ä»»åŠ¡å½“å‰æ‰§è¡ŒçŠ¶æ€åŠç»“æœã€‚

## ğŸ“‚ ç›®å½•ç»“æ„

```text
â”œâ”€â”€ agent/
â”‚   â”œâ”€â”€ nodes/          # çŠ¶æ€æœºèŠ‚ç‚¹é€»è¾‘ (ç†è§£, è§„åˆ’, æ‰§è¡Œ, åé¦ˆ, æŠ¥å‘Š)
â”‚   â”œâ”€â”€ prompts/        # LLM æç¤ºè¯æ¨¡æ¿
â”‚   â”œâ”€â”€ tools/          # Agent å·¥å…·é›† (SQL, Python REPL, Viz)
â”‚   â”œâ”€â”€ graph.py        # LangGraph å·¥ä½œæµå®šä¹‰
â”‚   â”œâ”€â”€ state.py        # çŠ¶æ€ Schema å®šä¹‰
â”‚   â””â”€â”€ utils.py        # æ¨¡å‹é€‚é…ä¸å…¬å…±å·¥å…·
â”œâ”€â”€ data/               # æ•°æ®åŠ è½½ä¸åˆå§‹åŒ–è„šæœ¬
â”œâ”€â”€ logs/               # è¿è¡Œæ—¥å¿—
â”œâ”€â”€ reports/            # åˆ†æäº§å‡º
â”‚   â”œâ”€â”€ files/          # ç”Ÿæˆçš„ Markdown æŠ¥å‘Š
â”‚   â””â”€â”€ images/         # è‡ªåŠ¨ç”Ÿæˆçš„å›¾è¡¨ (.png)
â”œâ”€â”€ templates/          # æŠ¥å‘Š Markdown æ¨¡æ¿ (Jinja2)
â”œâ”€â”€ app.py              # FastAPI åº”ç”¨å…¥å£
â”œâ”€â”€ test_agent.py       # å‘½ä»¤è¡Œé›†æˆæµ‹è¯•è„šæœ¬
â””â”€â”€ requirements.txt    # ä¾èµ–åˆ—è¡¨
```

## ğŸ“Š ç¤ºä¾‹æ¼”ç¤º

**ç”¨æˆ·éœ€æ±‚**: *"åˆ†æéš†åŸºç»¿èƒ½æœ€è¿‘ä¸¤å¹´çš„å‡€åˆ©æ¶¦å¢é•¿æƒ…å†µï¼Œå¹¶ç»˜åˆ¶è¶‹åŠ¿å›¾ã€‚"*

1. **ç†è§£é˜¶æ®µ**: è¯†åˆ«å‡ºéœ€è¦æŸ¥è¯¢ `pv_financials` è¡¨ï¼Œè¿‡æ»¤æ¡ä»¶ä¸º `company_name='éš†åŸºç»¿èƒ½'`ã€‚
2. **è§„åˆ’é˜¶æ®µ**: 
   - Step 1: `sql_query` è·å–è´¢åŠ¡æŠ¥è¡¨æ•°æ®ã€‚
   - Step 2: `python_analysis` è®¡ç®—å‡€åˆ©æ¶¦å¢é•¿ç‡ã€‚
   - Step 3: `visualizer` ç»˜åˆ¶æŠ˜çº¿è¶‹åŠ¿å›¾ã€‚
3. **åé¦ˆé˜¶æ®µ**: è‡ªåŠ¨æš‚åœå¹¶å±•ç¤ºè®¡åˆ’ï¼Œç­‰å¾…ç”¨æˆ·è¾“å…¥ "OK" æˆ–ä¿®æ”¹å»ºè®®ã€‚
4. **æ‰§è¡Œé˜¶æ®µ**: è‡ªåŠ¨è°ƒç”¨å¯¹åº”å·¥å…·ï¼Œå¤„ç† MySQL ç»“æœå¹¶ç”Ÿæˆå›¾ç‰‡ï¼Œä¸­é—´è¿‡ç¨‹å…¨è‡ªåŠ¨åŒ–ã€‚
5. **æŠ¥å‘Šé˜¶æ®µ**: æ±‡æ€»æ‰€æœ‰æ‰§è¡Œç»“æœï¼Œåœ¨ `reports/files/` ç›®å½•ä¸‹ç”Ÿæˆç»“æ„åŒ–çš„åˆ†ææŠ¥å‘Šã€‚
